# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger: none
pr:
  - master
  - dev

pool:
  vmImage: 'Ubuntu-16.04'
strategy:
  matrix:
    Python37:
      python.version: '3.7'

stages:
  - stage: Check
    jobs:
      - job: Test
        steps:
          - template: .use-python.yml
          - script: pytest tests --cov=serious
            displayName: 'Test'

      - job: Mypy
        steps:
          - template: .use-python.yml
          - script: mypy serious
            displayName: 'Check typings'

      - job: CheckVersion
        steps:
          - template: .use-python.yml
          - script: python version.py
            displayName: 'Check version changed'

  - stage: Report
    jobs:
      - job: TestCoverage
        steps:
          - template: .use-python.yml
          - script: git checkout $(System.PullRequest.SourceBranch)
            displayName: 'Checkout branch'

          - script: pytest tests --cov=serious --cov-report=html
            displayName: 'Test'

          - script: coveralls
            displayName: 'Save code coverage'
            env:
              COVERALLS_REPO_TOKEN: $(COVERALLS_REPO_TOKEN)
    dependsOn:
      - Check
      condition: succeeded('Check')

